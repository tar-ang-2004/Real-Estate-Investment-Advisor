{% extends 'base.html' %}

{% block title %}Results - PropInvest AI{% endblock %}

{% block content %}
<section class="min-h-screen py-12 mesh-gradient">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-12" data-aos="fade-down">
            <div class="inline-flex items-center px-4 py-2 rounded-full bg-white/5 border border-white/10 mb-6">
                <span class="w-2 h-2 bg-green-400 rounded-full mr-2 pulse-dot"></span>
                <span class="text-sm text-gray-300">Analysis Complete</span>
            </div>
            <h1 class="font-display text-4xl md:text-5xl font-bold text-white mb-4">
                Your Investment <span class="gradient-text">Analysis</span>
            </h1>
            <p class="text-xl text-gray-400">AI-powered insights for your property investment decision</p>
        </div>
        
        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Main Results Column -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Investment Classification Card -->
                <div class="glass rounded-3xl overflow-hidden {% if results.good_investment == 'Yes' %}glow-green{% else %}border-red-500/30{% endif %}" data-aos="fade-up">
                    <div class="p-8">
                        <div class="flex items-start justify-between mb-8">
                            <div>
                                <div class="text-sm text-gray-400 mb-2">Investment Classification</div>
                                <div class="flex items-center gap-4">
                                    {% if results.good_investment == 'Yes' %}
                                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-green-400 to-emerald-600 flex items-center justify-center">
                                        <i class="fas fa-thumbs-up text-white text-2xl"></i>
                                    </div>
                                    <div>
                                        <h2 class="text-3xl font-bold text-green-400">Good Investment</h2>
                                        <p class="text-gray-400">This property meets our investment criteria</p>
                                    </div>
                                    {% else %}
                                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center">
                                        <i class="fas fa-thumbs-down text-white text-2xl"></i>
                                    </div>
                                    <div>
                                        <h2 class="text-3xl font-bold text-red-400">Not Recommended</h2>
                                        <p class="text-gray-400">Consider negotiating price or other properties</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-5xl font-bold {% if results.good_investment == 'Yes' %}text-green-400{% else %}text-red-400{% endif %}">
                                    {{ results.investment_confidence }}%
                                </div>
                                <div class="text-sm text-gray-400">Confidence</div>
                            </div>
                        </div>
                        
                        <!-- Confidence Bars -->
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-sm text-gray-400">Good Investment Probability</span>
                                    <span class="text-sm font-semibold text-green-400">{{ results.confidence_good }}%</span>
                                </div>
                                <div class="h-3 rounded-full bg-white/10 overflow-hidden">
                                    <div class="h-full rounded-full bg-gradient-to-r from-green-400 to-emerald-500 transition-all duration-1000" style="width: 0%" data-width="{{ results.confidence_good }}%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-sm text-gray-400">Not Recommended Probability</span>
                                    <span class="text-sm font-semibold text-red-400">{{ results.confidence_bad }}%</span>
                                </div>
                                <div class="h-3 rounded-full bg-white/10 overflow-hidden">
                                    <div class="h-full rounded-full bg-gradient-to-r from-red-400 to-red-500 transition-all duration-1000" style="width: 0%" data-width="{{ results.confidence_bad }}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Analysis & Alerts Section - Always Shown -->
                <div class="glass rounded-3xl overflow-hidden {% if results.price_ratio > 1.5 %}border-yellow-500/30{% elif results.price_ratio < 0.8 %}border-green-500/30{% else %}border-teal-500/30{% endif %}" data-aos="fade-up" data-aos-delay="50">
                    <div class="p-6">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-xl {% if results.price_ratio > 1.5 %}bg-yellow-500/20{% elif results.price_ratio < 0.8 %}bg-green-500/20{% else %}bg-teal-500/20{% endif %} flex items-center justify-center mr-3">
                                <i class="fas {% if results.price_ratio > 1.5 %}fa-exclamation-triangle text-yellow-400{% elif results.price_ratio < 0.8 %}fa-check-circle text-green-400{% else %}fa-chart-bar text-teal-400{% endif %}"></i>
                            </div>
                            <h3 class="text-xl font-bold text-white">Investment Alerts</h3>
                        </div>
                        
                        <!-- Warnings/Alerts -->
                        {% if results.warnings and results.warnings|length > 0 %}
                        <div class="space-y-3 mb-4">
                            {% for warning in results.warnings %}
                            <div class="p-4 rounded-xl {% if '✅' in warning %}bg-green-500/10 border border-green-500/20{% else %}bg-yellow-500/10 border border-yellow-500/20{% endif %}">
                                <p class="{% if '✅' in warning %}text-green-300{% else %}text-yellow-300{% endif %}">{{ warning }}</p>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="p-4 rounded-xl bg-teal-500/10 border border-teal-500/20 mb-4">
                            <p class="text-teal-300">✅ Price appears reasonable for this location and property type</p>
                        </div>
                        {% endif %}
                        
                        <!-- Price Analysis - Always Shown -->
                        <div class="p-4 rounded-xl bg-white/5 border border-white/10">
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">Your Price/Sq Ft</div>
                                    <div class="text-lg font-bold {% if results.price_ratio > 1.5 %}text-red-400{% elif results.price_ratio < 0.8 %}text-green-400{% else %}text-white{% endif %}">
                                        ₹{{ results.price_per_sqft|int|default(0) }}
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">Market Avg</div>
                                    <div class="text-lg font-bold text-gray-300">₹{{ results.city_benchmark|default(0) }}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">Price Ratio</div>
                                    <div class="text-lg font-bold {% if results.price_ratio > 1.5 %}text-red-400{% elif results.price_ratio < 0.8 %}text-green-400{% else %}text-teal-400{% endif %}">
                                        {{ results.price_ratio|default(1)|round(2) }}x
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Forecast Card -->
                <div class="glass rounded-3xl overflow-hidden" data-aos="fade-up" data-aos-delay="100">
                    <div class="p-8">
                        <div class="flex items-center mb-6">
                            <div class="w-12 h-12 rounded-xl bg-amber-500/20 flex items-center justify-center mr-4">
                                <i class="fas fa-chart-line text-amber-400 text-xl"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-white">5-Year Price Forecast</h2>
                        </div>
                        
                        <!-- Price Stats -->
                        <div class="grid md:grid-cols-3 gap-6 mb-8">
                            <div class="p-6 rounded-2xl bg-white/5 border border-white/10 text-center">
                                <div class="text-sm text-gray-400 mb-2">Current Price</div>
                                <div class="text-3xl font-bold text-white">₹{{ results.current_price }}L</div>
                            </div>
                            <div class="p-6 rounded-2xl bg-gradient-to-br from-amber-500/20 to-teal-500/20 border border-amber-500/30 text-center">
                                <div class="text-sm text-gray-400 mb-2">Predicted Price (5Y)</div>
                                <div class="text-3xl font-bold text-amber-400">₹{{ results.future_price }}L</div>
                            </div>
                            <div class="p-6 rounded-2xl {% if results.appreciation > 0 %}bg-green-500/10 border-green-500/30{% else %}bg-red-500/10 border-red-500/30{% endif %} border text-center">
                                <div class="text-sm text-gray-400 mb-2">Appreciation</div>
                                <div class="text-3xl font-bold {% if results.appreciation > 0 %}text-green-400{% else %}text-red-400{% endif %}">
                                    {% if results.appreciation > 0 %}+{% endif %}{{ results.appreciation }}%
                                </div>
                            </div>
                        </div>
                        
                        <!-- Price Chart -->
                        <div class="h-64">
                            <canvas id="priceChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Feature Importance Card -->
                <div class="glass rounded-3xl overflow-hidden" data-aos="fade-up" data-aos-delay="200">
                    <div class="p-8">
                        <div class="flex items-center mb-6">
                            <div class="w-12 h-12 rounded-xl bg-cyan-500/20 flex items-center justify-center mr-4">
                                <i class="fas fa-sort-amount-down text-cyan-400 text-xl"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-white">Key Influencing Factors</h2>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-8">
                            <!-- Classification Factors -->
                            <div>
                                <h3 class="text-lg font-semibold text-amber-400 mb-4 flex items-center">
                                    <i class="fas fa-check-circle mr-2"></i>Investment Classification
                                </h3>
                                <div class="space-y-3">
                                    {% for feature, importance in results.clf_importance.items() %}
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <span class="text-sm text-gray-300">{{ feature.replace('_', ' ') }}</span>
                                            <span class="text-sm font-semibold text-amber-400">{{ (importance * 100)|round(1) }}%</span>
                                        </div>
                                        <div class="h-2 rounded-full bg-white/10 overflow-hidden">
                                            <div class="h-full rounded-full bg-gradient-to-r from-amber-400 to-amber-600" style="width: {{ importance * 100 }}%"></div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Price Prediction Factors -->
                            <div>
                                <h3 class="text-lg font-semibold text-teal-400 mb-4 flex items-center">
                                    <i class="fas fa-chart-line mr-2"></i>Price Prediction
                                </h3>
                                <div class="space-y-3">
                                    {% for feature, importance in results.reg_importance.items() %}
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <span class="text-sm text-gray-300">{{ feature.replace('_', ' ') }}</span>
                                            <span class="text-sm font-semibold text-teal-400">{{ (importance * 100)|round(1) }}%</span>
                                        </div>
                                        <div class="h-2 rounded-full bg-white/10 overflow-hidden">
                                            <div class="h-full rounded-full bg-gradient-to-r from-teal-400 to-teal-600" style="width: {{ importance * 100 }}%"></div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="space-y-8">
                <!-- Property Summary -->
                <div class="glass rounded-3xl overflow-hidden" data-aos="fade-left">
                    <div class="p-6 border-b border-white/10">
                        <h3 class="text-lg font-semibold text-white flex items-center">
                            <i class="fas fa-building text-amber-400 mr-3"></i>Property Summary
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-3 border-b border-white/5">
                                <span class="text-gray-400">State</span>
                                <span class="font-semibold text-white">{{ form_data.state }}</span>
                            </div>
                            <div class="flex justify-between items-center py-3 border-b border-white/5">
                                <span class="text-gray-400">City</span>
                                <span class="font-semibold text-white">{{ form_data.city }}</span>
                            </div>
                            <div class="flex justify-between items-center py-3 border-b border-white/5">
                                <span class="text-gray-400">Type</span>
                                <span class="font-semibold text-white">{{ form_data.property_type }}</span>
                            </div>
                            <div class="flex justify-between items-center py-3 border-b border-white/5">
                                <span class="text-gray-400">BHK</span>
                                <span class="font-semibold text-white">{{ form_data.bhk }} BHK</span>
                            </div>
                            <div class="flex justify-between items-center py-3 border-b border-white/5">
                                <span class="text-gray-400">Size</span>
                                <span class="font-semibold text-white">{{ form_data.size_sqft }} sq ft</span>
                            </div>
                            <div class="flex justify-between items-center py-3 border-b border-white/5">
                                <span class="text-gray-400">Price</span>
                                <span class="font-semibold text-white">₹{{ form_data.price }} Lakhs</span>
                            </div>
                            <div class="flex justify-between items-center py-3 border-b border-white/5">
                                <span class="text-gray-400">Year Built</span>
                                <span class="font-semibold text-white">{{ form_data.year_built }}</span>
                            </div>
                            <div class="flex justify-between items-center py-3">
                                <span class="text-gray-400">Furnished</span>
                                <span class="font-semibold text-white">{{ form_data.furnished_status }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Insights -->
                <div class="glass rounded-3xl p-6" data-aos="fade-left" data-aos-delay="100">
                    <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                        <i class="fas fa-lightbulb text-yellow-400 mr-3"></i>Quick Insights
                    </h3>
                    <div class="space-y-3">
                        {% if results.appreciation > 30 %}
                        <div class="p-3 rounded-xl bg-green-500/10 border border-green-500/30">
                            <span class="text-green-400 text-sm"><i class="fas fa-arrow-up mr-2"></i>High growth potential detected</span>
                        </div>
                        {% endif %}
                        {% if results.confidence_good > 70 %}
                        <div class="p-3 rounded-xl bg-amber-500/10 border border-amber-500/30">
                            <span class="text-amber-400 text-sm"><i class="fas fa-star mr-2"></i>Strong investment confidence</span>
                        </div>
                        {% endif %}
                        {% if form_data.availability == 'Ready_to_Move' %}
                        <div class="p-3 rounded-xl bg-cyan-500/10 border border-cyan-500/30">
                            <span class="text-cyan-400 text-sm"><i class="fas fa-home mr-2"></i>Ready to move - Immediate possession</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="glass rounded-3xl p-6" data-aos="fade-left" data-aos-delay="200">
                    <h3 class="text-lg font-semibold text-white mb-4">What's Next?</h3>
                    <div class="space-y-3">
                        <a href="/predict" class="flex items-center justify-center w-full px-6 py-3 rounded-xl bg-gradient-to-r from-amber-500 to-orange-600 text-white font-semibold hover:shadow-lg hover:shadow-amber-500/30 transition-all">
                            <i class="fas fa-redo mr-2"></i>New Prediction
                        </a>
                        <a href="/insights" class="flex items-center justify-center w-full px-6 py-3 rounded-xl border border-white/20 text-white font-semibold hover:bg-white/5 transition-all">
                            <i class="fas fa-chart-bar mr-2"></i>Market Insights
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    // Animate confidence bars on load
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            document.querySelectorAll('[data-width]').forEach(el => {
                el.style.width = el.dataset.width;
            });
        }, 500);
    });
    
    // Price projection chart
    const ctx = document.getElementById('priceChart').getContext('2d');
    const currentPrice = {{ results.current_price }};
    const futurePrice = {{ results.future_price }};
    const years = ['Now', 'Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5'];
    
    const growthRate = Math.pow(futurePrice / currentPrice, 1/5);
    const prices = [currentPrice];
    for (let i = 1; i <= 5; i++) {
        prices.push(Math.round(currentPrice * Math.pow(growthRate, i) * 100) / 100);
    }
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: years,
            datasets: [{
                label: 'Projected Price (Lakhs)',
                data: prices,
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#f59e0b',
                pointBorderColor: '#1e293b',
                pointBorderWidth: 3,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(30, 41, 59, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#94a3b8',
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return '₹' + context.parsed.y.toFixed(2) + ' Lakhs';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: {
                        color: '#94a3b8',
                        callback: function(value) { return '₹' + value + 'L'; }
                    }
                },
                x: {
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    ticks: { color: '#94a3b8' }
                }
            }
        }
    });
</script>
{% endblock %}
